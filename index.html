<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam & Thailand Adventure Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 14px 20px; font-size: 14px; line-height: 1.4; }
        .leaflet-popup-content h3 { margin: 0 0 5px; font-weight: bold; }
        .leaflet-container { font-family: 'Inter', sans-serif; }
        .highlight { background-color: #fef9c3; border-left: 4px solid #f59e0b; }
        .day-details-panel {
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .day-details-panel.active {
            max-height: 1000px; /* Sufficiently large to show content */
            opacity: 1;
        }
    </style>
    <!-- Chosen Palette: "Tropical Serenity" - A mix of calming sea blues, lush jungle greens, and warm sandy beige. -->
    <!-- Application Structure Plan: A responsive, two-panel layout. On the left (or top on mobile), the main itinerary list displays daily summaries. Clicking a day expands a nested detail section to reveal specific events (places, times, activities) for that day. On the right (or bottom), an interactive Leaflet map dynamically visualizes either all main itinerary locations (default) or the detailed events of a selected day. This hierarchical structure allows users to progressively explore information. Edit and remove functionalities are available for both main days and individual events. A global "Add New Item" button creates new days, while an "Add Event" button within the daily detail view allows adding sub-events. This design prioritizes user understanding and ease of navigation by providing contextual information and granular control. -->
    <!-- Visualization & Content Choices: The core visualization remains a Leaflet.js map, now dynamically updating its markers based on the selected itinerary view (main days vs. specific day's events). Itinerary data is structured hierarchically in JavaScript objects to support nested events. HTML lists are used for both main itinerary days and the detailed event lists. Vanilla JavaScript handles all interactions: expanding/collapsing daily details, opening/closing modals, and dynamically updating both textual content and map markers. Custom modals are used for confirmations and form inputs to maintain a consistent UI/UX. The interaction model is click-to-drill-down, providing a clear path for information exploration. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Vietnam & Thailand Adventure</h1>
            <p class="text-lg text-gray-600 mt-2">August 21 - September 17</p>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Itinerary Panel -->
            <div id="itinerary-panel" class="w-full md:w-1/3 bg-white p-4 rounded-lg shadow-lg overflow-y-auto" style="height: 75vh;">
                <h2 class="text-2xl font-bold mb-4 text-gray-700 border-b pb-2">Your Itinerary</h2>
                <div id="itinerary-list" class="space-y-4">
                    <!-- Itinerary items will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Map Panel -->
            <div class="w-full md:w-2/3 h-[50vh] md:h-[75vh] rounded-lg shadow-lg overflow-hidden">
                <div id="map" class="w-full h-full"></div>
            </div>
        </div>
    </div>

    <!-- Add New Item Button -->
    <button id="add-item-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg z-[9998]">
        + Add New Day
    </button>

    <!-- Modal for Editing/Adding -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[9999]">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Edit Itinerary Item</h3>
                <div class="mt-2 px-7 py-3">
                    <div id="new-item-fields" class="space-y-4 mb-4 hidden">
                        <div class="text-left">
                            <label for="new-day" class="text-sm font-medium text-gray-700">Day (e.g., Aug 20, Sep 1-4):</label>
                            <input type="text" id="new-day" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div class="text-left">
                            <label for="new-location" class="text-sm font-medium text-gray-700">Main Location (e.g., Hanoi):</label>
                            <input type="text" id="new-location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div class="text-left">
                            <label for="new-summary-activity" class="text-sm font-medium text-gray-700">Summary Activity:</label>
                            <input type="text" id="new-summary-activity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                    </div>
                    <!-- Fields for editing/adding individual events -->
                    <div id="event-fields" class="space-y-4 mb-4 hidden">
                        <div class="text-left">
                            <label for="event-time" class="text-sm font-medium text-gray-700">Time (e.g., 13:15):</label>
                            <input type="text" id="event-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div class="text-left">
                            <label for="event-place" class="text-sm font-medium text-gray-700">Place:</label>
                            <input type="text" id="event-place" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="text-left w-full sm:w-1/2">
                                <label for="event-latitude" class="text-sm font-medium text-gray-700">Latitude:</label>
                                <input type="number" step="any" id="event-latitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                            </div>
                            <div class="text-left w-full sm:w-1/2">
                                <label for="event-longitude" class="text-sm font-medium text-gray-700">Longitude:</label>
                                <input type="number" step="any" id="event-longitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                            </div>
                        </div>
                    </div>
                    <div class="text-left">
                        <label for="edit-activity" class="text-sm font-medium text-gray-700">Activity/Plan:</label>
                        <textarea id="edit-activity" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"></textarea>
                    </div>
                    <div class="text-left mt-4">
                        <label for="edit-notes" class="text-sm font-medium text-gray-700">Notes (e.g., Kosher Food, Hotel):</label>
                        <textarea id="edit-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"></textarea>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-button" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Save Changes
                    </button>
                    <button id="close-modal" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const LOCAL_STORAGE_KEY = 'travelItineraryData';

            // Default itinerary data
            const defaultItineraryData = [
                { day: "Aug 21", location: "En Route", summary_activity: "Depart from Israel", events: [
                    { time: "13:40", place: "Israel", coords: [31.0461, 34.8516], activity: "Depart from Israel", notes: "Morning flight. Layover in Dubai (leaving around 3 AM)." }
                ]},
                { day: "Aug 22", location: "Hanoi", summary_activity: "Arrive & Shabbat Prep", events: [ // Arrive Friday
                    { time: "13:15", place: "Noi Bai International Airport (HAN)", coords: [21.2211, 105.8077], activity: "Land in Hanoi", notes: "Take taxi to hotel." },
                    { time: "Afternoon", place: "Hotel near Chabad House", coords: [21.0315, 105.8500], activity: "Check into hotel", notes: "Settle in, explore immediate area." },
                    { time: "Evening", place: "Old Quarter / Chabad House", coords: [21.0315, 105.8500], activity: "Shabbat Prep & Welcome Shabbat", notes: "Dinner at Chabad House." }
                ]},
                { day: "Aug 23", location: "Hanoi", summary_activity: "Shabbat in Hanoi", events: [ // Saturday
                    { time: "Day", place: "Chabad House of Hanoi", coords: [21.0315, 105.8500], activity: "Observe Shabbat", notes: "Attend services and meals." }
                ]},
                { day: "Aug 24", location: "Ninh Binh & Sapa", summary_activity: "Ninh Binh Day Trip & Night Train to Sapa", events: [ // Sunday
                    { time: "Full Day", place: "Tam Coc / Trang An & Mua Cave", coords: [20.2528, 105.9738], activity: "Sampan boat ride & Mua Cave viewpoint", notes: "Arrange private car or tour. Return to Hanoi." },
                    { time: "Evening", place: "Hanoi Railway Station", coords: [21.0210, 105.8390], activity: "Board overnight train to Lao Cai (~10 PM)", notes: "Book private cabin. Pre-packed kosher meals." }
                ]},
                { day: "Aug 25", location: "Sapa", summary_activity: "Sapa Exploration Day 1", events: [ // Monday
                    { time: "Morning", place: "Lao Cai / Sapa Town", coords: [22.4833, 103.9667], activity: "Arrive in Lao Cai, transfer to Sapa", notes: "Check into hotel. Rely on pre-packed kosher food." },
                    { time: "Afternoon", place: "Cat Cat Village", coords: [22.3667, 103.8167], activity: "Light trek to Cat Cat village", notes: "" }
                ]},
                { day: "Aug 26", location: "Sapa", summary_activity: "Sapa Exploration Day 2", events: [ // Tuesday
                    { time: "Full Day", place: "Ta Van / Lao Chai Villages", coords: [22.3000, 103.8667], activity: "Trek in Sapa villages", notes: "Consider local guide. Enjoy scenery." }
                ]},
                { day: "Aug 27", location: "Sapa & Hanoi", summary_activity: "Sapa Exploration Day 3 & Return to Hanoi", events: [ // Wednesday
                    { time: "Morning", place: "Sapa", coords: [22.3365, 103.8439], activity: "Final Sapa activities", notes: "Last chance for views/souvenirs." },
                    { time: "Late Afternoon", place: "Lao Cai Railway Station", coords: [22.4833, 103.9667], activity: "Board overnight train back to Hanoi", notes: "" }
                ]},
                { day: "Aug 28", location: "Ha Long Bay", summary_activity: "Day Trip to Ha Long Bay", events: [ // Thursday
                    { time: "Full Day", place: "Ha Long Bay", coords: [20.9101, 107.0759], activity: "Full-day cruise through limestone karsts", notes: "Book reputable tour. Bring kosher lunch/snacks. Return to Hanoi for sleep." }
                ]},
                { day: "Aug 29", location: "Koh Samui", summary_activity: "Fly to Koh Samui, Thailand", events: [ // Friday
                    { time: "Morning/Afternoon", place: "Hanoi Airport (HAN)", coords: [21.2211, 105.8077], activity: "Depart Hanoi", notes: "" },
                    { time: "Afternoon/Evening", place: "Koh Samui Airport (USM)", coords: [9.5467, 100.0633], activity: "Arrive Koh Samui", notes: "Check into hotel near Chabad House for Shabbat." }
                ]},
                { day: "Aug 30", location: "Koh Samui", summary_activity: "Shabbat in Koh Samui", events: [ // Saturday
                    { time: "Day", place: "Chabad House of Koh Samui", coords: [9.5200, 100.0400], activity: "Observe Shabbat", notes: "Attend services and meals. Relax on beach." }
                ]},
                { day: "Aug 31", location: "Koh Samui", summary_activity: "Koh Samui Exploration Day 1", events: [ // Sunday
                    { time: "Various", place: "Big Buddha Temple", coords: [9.5600, 100.0600], activity: "Visit Big Buddha", notes: "" }
                ]},
                { day: "Sep 1", location: "Koh Samui", summary_activity: "Koh Samui Exploration Day 2", events: [ // Monday
                    { time: "Various", place: "Wat Plai Laem", coords: [9.5550, 100.0550], activity: "Visit Wat Plai Laem", notes: "" }
                ]},
                { day: "Sep 2", location: "Koh Samui", summary_activity: "Koh Samui Exploration Day 3", events: [ // Tuesday
                    { time: "Various", place: "Chaweng Beach / Lamai Beach", coords: [9.5167, 100.0500], activity: "Enjoy beaches", notes: "" }
                ]},
                { day: "Sep 3", location: "Koh Samui", summary_activity: "Koh Samui Exploration Day 4", events: [ // Wednesday
                    { time: "Various", place: "Koh Samui Activities", coords: [9.5357, 99.9357], activity: "Free day for leisure or optional activities", notes: "" }
                ]},
                { day: "Sep 4", location: "Koh Phangan", summary_activity: "Ferry to Koh Phangan", events: [ // Thursday
                    { time: "Morning", place: "Koh Samui Ferry Terminal", coords: [9.5467, 100.0633], activity: "Ferry to Koh Phangan", notes: "Check into hotel near Chabad House." },
                    { time: "Afternoon", place: "Koh Phangan", coords: [9.7354, 100.0136], activity: "Explore the island", notes: "" }
                ]},
                { day: "Sep 5", location: "Koh Phangan", summary_activity: "Koh Phangan Exploration", events: [ // Friday
                    { time: "Day", place: "Koh Phangan Beaches", coords: [9.7354, 100.0136], activity: "Relax on beaches", notes: "" },
                    { time: "Evening", place: "Chabad House of Koh Phangan", coords: [9.7354, 100.0136], activity: "Prepare for Shabbat, Dinner at Chabad", notes: "" }
                ]},
                { day: "Sep 6", location: "Koh Phangan", summary_activity: "Shabbat in Koh Phangan", events: [ // Saturday
                    { time: "Day", place: "Chabad House of Koh Phangan", coords: [9.7354, 100.0136], activity: "Observe Shabbat", notes: "Attend services and meals." }
                ]},
                { day: "Sep 7", location: "Koh Tao", summary_activity: "Ferry to Koh Tao", events: [ // Sunday
                    { time: "Morning", place: "Koh Phangan Ferry Terminal", coords: [9.7354, 100.0136], activity: "Ferry to Koh Tao", notes: "Check into hotel near Chabad House." },
                    { time: "Day", place: "Koh Tao", coords: [10.0956, 99.8413], activity: "Explore Koh Tao", notes: "Great for diving/snorkeling." }
                ]},
                { day: "Sep 8", location: "Koh Tao", summary_activity: "Koh Tao Activities", events: [ // Monday
                    { time: "Day", place: "Koh Tao Bays", coords: [10.0956, 99.8413], activity: "Diving, snorkeling, or hiking", notes: "" }
                ]},
                { day: "Sep 9", location: "Koh Samui & Bangkok", summary_activity: "Return & Travel to Bangkok", events: [ // Tuesday
                    { time: "Morning", place: "Koh Tao Ferry Terminal", coords: [10.0956, 99.8413], activity: "Ferry back to Koh Samui", notes: "" },
                    { time: "Afternoon/Evening", place: "Koh Samui Airport (USM)", coords: [9.5467, 100.0633], activity: "Fly to Bangkok", notes: "" }
                ]},
                { day: "Sep 10", location: "Bangkok", summary_activity: "Bangkok Exploration Day 1", events: [ // Wednesday
                    { time: "Various", place: "Grand Palace & Wat Pho", coords: [13.7500, 100.4900], activity: "Visit Grand Palace & Wat Pho", notes: "" }
                ]},
                { day: "Sep 11", location: "Bangkok", summary_activity: "Bangkok Exploration Day 2", events: [ // Thursday
                    { time: "Various", place: "Wat Arun", coords: [13.7500, 100.4800], activity: "Visit Wat Arun", notes: "" }
                ]},
                { day: "Sep 12", location: "Bangkok", summary_activity: "Bangkok Exploration Day 3", events: [ // Friday
                    { time: "Various", place: "Markets & Malls", coords: [13.7400, 100.5300], activity: "Explore markets and malls", notes: "Many kosher options available." },
                    { time: "Evening", place: "Chabad House of Bangkok", coords: [13.7300, 100.5600], activity: "Prepare for Shabbat, Dinner at Chabad", notes: "" }
                ]},
                { day: "Sep 13", location: "Bangkok", summary_activity: "Shabbat in Bangkok", events: [ // Saturday
                    { time: "Day", place: "Chabad House of Bangkok", coords: [13.7300, 100.5600], activity: "Observe Shabbat", notes: "Attend services and meals." }
                ]},
                { day: "Sep 14", location: "Bangkok", summary_activity: "Bangkok Free Day 1", events: [ // Sunday
                    { time: "Day", place: "Bangkok", coords: [13.7563, 100.5018], activity: "More exploration or relaxation", notes: "Buffer day." }
                ]},
                { day: "Sep 15", location: "Bangkok", summary_activity: "Bangkok Free Day 2", events: [ // Monday
                    { time: "Day", place: "Bangkok", coords: [13.7563, 100.5018], activity: "More exploration or relaxation", notes: "Buffer day." }
                ]},
                { day: "Sep 16", location: "Bangkok", summary_activity: "Bangkok Free Day 3", events: [ // Tuesday
                    { time: "Day", place: "Bangkok", coords: [13.7563, 100.5018], activity: "More exploration or relaxation", notes: "Buffer day." }
                ]},
                { day: "Sep 17", location: "Bangkok", summary_activity: "Departure", events: [ // Wednesday
                    { time: "Day", place: "Suvarnabhumi Airport (BKK)", coords: [13.6899, 100.7501], activity: "Fly from Bangkok back to Israel", notes: "" }
                ]}
            ];

            // Load itinerary data from local storage, or use default if none exists
            let itineraryData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || defaultItineraryData;

            const map = L.map('map').setView([15, 105], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const itineraryList = document.getElementById('itinerary-list');
            const modal = document.getElementById('edit-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const saveBtn = document.getElementById('save-button');
            const activityInput = document.getElementById('edit-activity');
            const notesInput = document.getElementById('edit-notes');
            const newDayInput = document.getElementById('new-day');
            const newLocationInput = document.getElementById('new-location');
            const newSummaryActivityInput = document.getElementById('new-summary-activity');
            const newItemFields = document.getElementById('new-item-fields');
            const addItemBtn = document.getElementById('add-item-btn');

            const eventFields = document.getElementById('event-fields');
            const eventTimeInput = document.getElementById('event-time');
            const eventPlaceInput = document.getElementById('event-place');
            const eventLatitudeInput = document.getElementById('event-latitude');
            const eventLongitudeInput = document.getElementById('event-longitude');

            let currentDayIndex = -1; // Index of the day being viewed/edited
            let currentEventIndex = -1; // Index of the event within the day being edited (-1 for adding new event)
            let modalMode = ''; // 'add-day', 'edit-day', 'add-event', 'edit-event'

            const markers = {};

            // Function to save itinerary data to local storage
            function saveItinerary() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(itineraryData));
            }

            function renderItinerary() {
                itineraryList.innerHTML = '';
                itineraryData.forEach((dayItem, dayIndex) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'relative p-4 border rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                    dayDiv.id = `day-item-${dayIndex}`;
                    dayDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-blue-600">${dayItem.day}: ${dayItem.location}</p>
                                <p class="text-sm text-gray-700 mt-1">${dayItem.summary_activity}</p>
                            </div>
                            <button data-index="${dayIndex}" class="edit-day-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Edit Day</button>
                        </div>
                        <span data-index="${dayIndex}" class="remove-day-x absolute top-2 right-2 text-red-500 cursor-pointer font-bold text-lg leading-none">&times;</span>
                        <div id="day-details-${dayIndex}" class="day-details-panel mt-4 space-y-2">
                            <h4 class="font-semibold text-gray-700 text-left border-b pb-1">Daily Events:</h4>
                            <div id="events-list-${dayIndex}" class="space-y-2"></div>
                            <button data-day-index="${dayIndex}" class="add-event-btn mt-2 w-full bg-green-500 hover:bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-md shadow-sm">
                                + Add Event
                            </button>
                        </div>
                    `;
                    itineraryList.appendChild(dayDiv);

                    renderDayEvents(dayIndex); // Render events for each day initially

                    // Event listener for expanding/collapsing day details
                    dayDiv.querySelector('div:first-child').addEventListener('click', (e) => {
                        if (!e.target.closest('.edit-day-btn') && !e.target.closest('.remove-day-x')) {
                            toggleDayDetails(dayIndex);
                        }
                    });
                });

                document.querySelectorAll('.edit-day-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditDayModal(parseInt(e.target.dataset.index, 10));
                    });
                });

                document.querySelectorAll('.remove-day-x').forEach(span => {
                    span.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const indexToRemove = parseInt(e.target.dataset.index, 10);
                        removeItineraryDay(indexToRemove);
                    });
                });

                document.querySelectorAll('.add-event-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAddEventModal(parseInt(e.target.dataset.dayIndex, 10));
                    });
                });
            }

            function renderDayEvents(dayIndex) {
                const eventsListContainer = document.getElementById(`events-list-${dayIndex}`);
                eventsListContainer.innerHTML = '';
                const dayItem = itineraryData[dayIndex];
                if (dayItem.events && dayItem.events.length > 0) {
                    dayItem.events.forEach((event, eventIndex) => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'relative p-2 border border-gray-200 rounded-md bg-gray-50 text-left text-sm';
                        eventDiv.innerHTML = `
                            <p class="font-medium text-gray-800">${event.time}: ${event.place}</p>
                            <p class="text-gray-600">${event.activity}</p>
                            <p class="text-xs text-gray-500"><em>${event.notes}</em></p>
                            <div class="absolute top-1 right-1 flex space-x-1">
                                <button data-day-index="${dayIndex}" data-event-index="${eventIndex}" class="edit-event-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-0.5 px-1.5 rounded">Edit</button>
                                <span data-day-index="${dayIndex}" data-event-index="${eventIndex}" class="remove-event-x text-red-400 cursor-pointer font-bold text-base leading-none">&times;</span>
                            </div>
                        `;
                        eventsListContainer.appendChild(eventDiv);
                    });

                    document.querySelectorAll(`#events-list-${dayIndex} .edit-event-btn`).forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openEditEventModal(parseInt(e.target.dataset.dayIndex, 10), parseInt(e.target.dataset.eventIndex, 10));
                        });
                    });

                    document.querySelectorAll(`#events-list-${dayIndex} .remove-event-x`).forEach(span => {
                        span.addEventListener('click', (e) => {
                            e.stopPropagation();
                            removeItineraryEvent(parseInt(e.target.dataset.dayIndex, 10), parseInt(e.target.dataset.eventIndex, 10));
                        });
                    });
                } else {
                    eventsListContainer.innerHTML = '<p class="text-gray-500 text-sm">No specific events planned for this day yet.</p>';
                }
            }

            function toggleDayDetails(dayIndex) {
                const detailsPanel = document.getElementById(`day-details-${dayIndex}`);
                const isActive = detailsPanel.classList.toggle('active');

                if (isActive) {
                    // When expanding, update map to show events for this day
                    renderMap(dayIndex);
                    // Scroll to the day item
                    const dayItemEl = document.getElementById(`day-item-${dayIndex}`);
                    if (dayItemEl) {
                        dayItemEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    // When collapsing, revert map to show all main locations
                    renderMap();
                }
            }

            function openEditDayModal(dayIndex) {
                currentDayIndex = dayIndex;
                currentEventIndex = -1;
                modalMode = 'edit-day';

                const dayItem = itineraryData[currentDayIndex];
                document.getElementById('modal-title').innerText = `Edit Day: ${dayItem.day} - ${dayItem.location}`;

                eventFields.classList.add('hidden');
                newItemFields.classList.remove('hidden');

                newDayInput.value = dayItem.day;
                newLocationInput.value = dayItem.location;
                newSummaryActivityInput.value = dayItem.summary_activity;
                activityInput.value = '';
                notesInput.value = '';

                modal.style.display = 'block';
            }

            function openEditEventModal(dayIndex, eventIndex) {
                currentDayIndex = dayIndex;
                currentEventIndex = eventIndex;
                modalMode = 'edit-event';

                const eventItem = itineraryData[currentDayIndex].events[currentEventIndex];
                document.getElementById('modal-title').innerText = `Edit Event: ${itineraryData[currentDayIndex].day} - ${eventItem.place}`;

                eventFields.classList.remove('hidden');
                newItemFields.classList.add('hidden');

                eventTimeInput.value = eventItem.time;
                eventPlaceInput.value = eventItem.place;
                eventLatitudeInput.value = eventItem.coords[0];
                eventLongitudeInput.value = eventItem.coords[1];
                activityInput.value = eventItem.activity;
                notesInput.value = eventItem.notes;

                modal.style.display = 'block';
            }

            function openAddModal() { // For adding a new day
                currentDayIndex = -1;
                currentEventIndex = -1;
                modalMode = 'add-day';

                document.getElementById('modal-title').innerText = `Add New Itinerary Day`;

                newItemFields.classList.remove('hidden');
                eventFields.classList.add('hidden');

                newDayInput.value = '';
                newLocationInput.value = '';
                newSummaryActivityInput.value = '';
                activityInput.value = '';
                notesInput.value = '';
                eventTimeInput.value = '';
                eventPlaceInput.value = '';
                eventLatitudeInput.value = '';
                eventLongitudeInput.value = '';

                modal.style.display = 'block';
            }

            function openAddEventModal(dayIndex) {
                currentDayIndex = dayIndex;
                currentEventIndex = -1;
                modalMode = 'add-event';

                document.getElementById('modal-title').innerText = `Add Event to ${itineraryData[currentDayIndex].day}`;

                eventFields.classList.remove('hidden');
                newItemFields.classList.add('hidden');

                eventTimeInput.value = '';
                eventPlaceInput.value = '';
                eventLatitudeInput.value = '';
                eventLongitudeInput.value = '';
                activityInput.value = '';
                notesInput.value = '';

                modal.style.display = 'block';
            }

            function removeItineraryDay(index) {
                const confirmationModal = document.createElement('div');
                confirmationModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[10000]';
                confirmationModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">Are you sure you want to remove this entire day from the itinerary?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-remove" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Yes, Remove</button>
                            <button id="cancel-remove" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationModal);

                document.getElementById('confirm-remove').addEventListener('click', () => {
                    itineraryData.splice(index, 1);
                    saveItinerary(); // Save changes to local storage
                    renderItinerary();
                    renderMap(); // Re-render map to show all main locations
                    document.body.removeChild(confirmationModal);
                });

                document.getElementById('cancel-remove').addEventListener('click', () => {
                    document.body.removeChild(confirmationModal);
                });
            }

            function removeItineraryEvent(dayIndex, eventIndex) {
                const confirmationModal = document.createElement('div');
                confirmationModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[10000]';
                confirmationModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">Are you sure you want to remove this event?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-remove" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Yes, Remove</button>
                            <button id="cancel-remove" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmationModal);

                document.getElementById('confirm-remove').addEventListener('click', () => {
                    itineraryData[dayIndex].events.splice(eventIndex, 1);
                    saveItinerary(); // Save changes to local storage
                    renderDayEvents(dayIndex); // Re-render only the events for this day
                    renderMap(dayIndex); // Update map with current day's events
                    document.body.removeChild(confirmationModal);
                });

                document.getElementById('cancel-remove').addEventListener('click', () => {
                    document.body.removeChild(confirmationModal);
                });
            }

            function highlightItineraryItem(dayIndex, eventIndex = -1) {
                document.querySelectorAll('#itinerary-list > div').forEach(div => div.classList.remove('highlight'));
                document.querySelectorAll('.day-details-panel div').forEach(div => div.classList.remove('highlight')); // Clear event highlights

                const dayItemEl = document.getElementById(`day-item-${dayIndex}`);
                if (dayItemEl) {
                    dayItemEl.classList.add('highlight');
                    dayItemEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Ensure the details panel for this day is open
                    const detailsPanel = document.getElementById(`day-details-${dayIndex}`);
                    if (!detailsPanel.classList.contains('active')) {
                        detailsPanel.classList.add('active');
                    }
                }

                if (eventIndex !== -1) {
                    const eventEl = document.querySelector(`#events-list-${dayIndex} div:nth-child(${eventIndex + 1})`);
                    if (eventEl) {
                        eventEl.classList.add('highlight');
                    }
                }
            }

            function renderMap(dayIndex = -1) {
                Object.values(markers).forEach(marker => map.removeLayer(marker)); // Clear all existing markers
                Object.keys(markers).forEach(key => delete markers[key]); // Clear markers object

                let locationsToMap = [];
                let coordsForBounds = []; // New array to collect all valid coordinates for fitting bounds

                if (dayIndex !== -1 && itineraryData[dayIndex] && itineraryData[dayIndex].events && itineraryData[dayIndex].events.length > 0) {
                    // Map mode: show events for a specific day
                    locationsToMap = itineraryData[dayIndex].events;
                } else {
                    // Default map mode: show main locations for all days
                    itineraryData.forEach(dayItem => {
                        if (dayItem.events && dayItem.events.length > 0 && dayItem.events[0].coords && dayItem.events[0].coords.length === 2) {
                            locationsToMap.push({
                                place: dayItem.location,
                                coords: dayItem.events[0].coords,
                                activity: dayItem.summary_activity
                            });
                        }
                    });
                }

                locationsToMap.forEach((item, index) => {
                    if (item.coords && item.coords.length === 2) {
                        const marker = L.marker(item.coords).addTo(map);
                        let popupContent = `<h3>${item.place}</h3>`;
                        if (item.time) popupContent += `<b>Time:</b> ${item.time}<br>`;
                        popupContent += `<b>Activity:</b> ${item.activity}<br>`;
                        if (item.notes) popupContent += `<em>${item.notes}</em>`;

                        marker.bindPopup(popupContent);
                        marker.on('click', () => {
                            if (dayIndex !== -1) {
                                const eventIdx = itineraryData[dayIndex].events.findIndex(e => e.place === item.place && e.activity === item.activity);
                                if (eventIdx !== -1) highlightItineraryItem(dayIndex, eventIdx);
                            } else {
                                const dayIdx = itineraryData.findIndex(d => d.location === item.place && d.summary_activity === item.activity);
                                if (dayIdx !== -1) highlightItineraryItem(dayIdx);
                            }
                        });
                        markers[item.place + (item.time || '') + index] = marker; // Unique key for marker
                        coordsForBounds.push(item.coords); // Collect coordinates here
                    }
                });

                // Fit map bounds after all markers are added and coords collected
                if (coordsForBounds.length > 0) {
                    // Calculate the center of the bounds and set a fixed zoom level for regional view
                    const bounds = L.latLngBounds(coordsForBounds);
                    map.setView(bounds.getCenter(), 7); // Zoom level 7 for a wider regional view
                } else {
                    map.setView([15, 105], 4); // Default view if no valid locations
                }
            }

            saveBtn.addEventListener('click', () => {
                const eventTime = eventTimeInput.value.trim();
                const eventPlace = eventPlaceInput.value.trim();
                const eventLat = parseFloat(eventLatitudeInput.value);
                const eventLon = parseFloat(eventLongitudeInput.value);
                const eventActivity = activityInput.value.trim();
                const eventNotes = notesInput.value.trim();
                const newDay = newDayInput.value.trim();
                const newLocation = newLocationInput.value.trim();
                const newSummaryActivity = newSummaryActivityInput.value.trim();

                switch (modalMode) {
                    case 'add-day':
                        if (newDay && newLocation && newSummaryActivity) {
                            itineraryData.push({
                                day: newDay,
                                location: newLocation,
                                summary_activity: newSummaryActivity,
                                events: []
                            });
                            saveItinerary();
                            renderItinerary();
                            renderMap();
                            modal.style.display = 'none';
                        } else {
                            showCustomAlert("Please fill in all required fields for the new day (Day, Main Location, Summary Activity).");
                        }
                        break;
                    case 'edit-day':
                        if (newDay && newLocation && newSummaryActivity) {
                            const dayItem = itineraryData[currentDayIndex];
                            dayItem.day = newDay;
                            dayItem.location = newLocation;
                            dayItem.summary_activity = newSummaryActivity;
                            saveItinerary();
                            renderItinerary();
                            renderMap();
                            modal.style.display = 'none';
                        } else {
                            showCustomAlert("Please fill in all required fields for the day (Day, Main Location, Summary Activity).");
                        }
                        break;
                    case 'add-event':
                        if (eventTime && eventPlace && !isNaN(eventLat) && !isNaN(eventLon) && eventActivity) {
                            itineraryData[currentDayIndex].events.push({
                                time: eventTime,
                                place: eventPlace,
                                coords: [eventLat, eventLon],
                                activity: eventActivity,
                                notes: eventNotes
                            });
                            saveItinerary();
                            renderDayEvents(currentDayIndex);
                            renderMap(currentDayIndex);
                            modal.style.display = 'none';
                        } else {
                            showCustomAlert("Please fill in all required fields for the event (Time, Place, Activity, Latitude, Longitude).");
                        }
                        break;
                    case 'edit-event':
                        if (eventTime && eventPlace && !isNaN(eventLat) && !isNaN(eventLon) && eventActivity) {
                            const eventItem = itineraryData[currentDayIndex].events[currentEventIndex];
                            eventItem.time = eventTime;
                            eventItem.place = eventPlace;
                            eventItem.coords = [eventLat, eventLon];
                            eventItem.activity = eventActivity;
                            eventItem.notes = eventNotes;
                            saveItinerary();
                            renderDayEvents(currentDayIndex);
                            renderMap(currentDayIndex);
                            modal.style.display = 'none';
                        } else {
                            showCustomAlert("Please fill in all required fields for the event (Time, Place, Activity, Latitude, Longitude).");
                        }
                        break;
                }
                // Reset state variables after save
                currentDayIndex = -1;
                currentEventIndex = -1;
                modalMode = '';
            });

            closeModalBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                currentDayIndex = -1;
                currentEventIndex = -1;
                modalMode = '';
            });

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                    currentDayIndex = -1;
                    currentEventIndex = -1;
                    modalMode = '';
                }
            }

            addItemBtn.addEventListener('click', openAddModal);

            function showCustomAlert(message) {
                const alertModal = document.createElement('div');
                alertModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[10000]';
                alertModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">${message}</p>
                        <button id="close-alert" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">OK</button>
                    </div>
                `;
                document.body.appendChild(alertModal);
                document.getElementById('close-alert').addEventListener('click', () => {
                    document.body.removeChild(alertModal);
                });
            }

            renderItinerary();
            // Initial map load for Day 1 and open its details
            if (itineraryData.length > 0) {
                renderMap(0);
                const firstDayDetailsPanel = document.getElementById(`day-details-0`);
                if (firstDayDetailsPanel) {
                    firstDayDetailsPanel.classList.add('active');
                }
            } else {
                renderMap(); // Fallback to global view if no data
            }
        });
    </script>
</body>
</html>
